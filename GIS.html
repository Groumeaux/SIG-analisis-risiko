<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peta Aman Warga - Prototipe</title>

    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Leaflet.js for the interactive map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- NEW: Leaflet Routing Machine for road network analysis -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

    <!-- Lucide Icons for a clean look -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Custom font and minor style adjustments */
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden; /* Prevent scrolling */
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        
        /* Ensure map attribution is visible */
        .leaflet-control-attribution {
            background: rgba(255, 255, 255, 0.7) !important;
            padding: 2px 5px;
            border-radius: 3px;
        }
        
        .leaflet-div-icon {
            background: transparent;
            border: none;
        }
        
        /* Hide scrollbars */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        
        /* Hide the default routing instructions panel */
        .leaflet-routing-container {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="relative h-screen w-screen">
        <!-- The map container, taking up the full screen -->
        <div id="map" class="h-full w-full z-10"></div>

        <!-- The sidebar control panel -->
        <div class="absolute top-4 left-4 z-20 bg-white p-6 rounded-lg shadow-xl w-[90%] max-w-md transition-transform duration-300 ease-in-out flex flex-col max-h-[calc(100vh-2rem)]" id="sidebar">
            
            <!-- Header section -->
            <div class="border-b pb-4 mb-4 flex-shrink-0">
                <h1 class="text-2xl font-bold text-gray-800">Peta Aman Warga</h1>
                <p class="text-sm text-gray-500">Prototipe Atlas Risiko & Kerentanan</p>
                <p class="text-xs text-gray-400 mt-2" id="current-time"></p>
            </div>

            <!-- Container for Layer List and Risk Assessment -->
            <div class="overflow-y-auto no-scrollbar flex-grow">
                <!-- Layer List (Initially visible) -->
                <div id="layer-list">
                    <div class="flex justify-between items-center mb-3">
                         <h2 class="text-lg font-semibold text-gray-700">Lapisan Data</h2>
                    </div>
                    <p class="text-sm text-gray-500 mb-4">Klik di mana saja pada peta untuk melihat laporan risiko lokasi tersebut.</p>
                    <div class="space-y-3">
                        <!-- Disaster Layers -->
                        <label for="banjir-toggle" class="flex items-center justify-between p-3 bg-red-50 rounded-md hover:bg-red-100 cursor-pointer">
                            <div class="flex items-center">
                                <i data-lucide="cloud-rain-wind" class="w-5 h-5 text-red-600 mr-3"></i>
                                <span class="font-medium text-red-800">Bencana Banjir</span>
                            </div>
                            <input type="checkbox" id="banjir-toggle" class="form-checkbox h-5 w-5 text-red-600 rounded focus:ring-red-500" checked>
                        </label>
                        <label for="longsor-toggle" class="flex items-center justify-between p-3 bg-yellow-50 rounded-md hover:bg-yellow-100 cursor-pointer">
                            <div class="flex items-center">
                               <i data-lucide="mountain" class="w-5 h-5 text-yellow-700 mr-3"></i>
                                <span class="font-medium text-yellow-800">Bencana Tanah Longsor</span>
                            </div>
                            <input type="checkbox" id="longsor-toggle" class="form-checkbox h-5 w-5 text-yellow-600 rounded focus:ring-yellow-500" checked>
                        </label>

                        <!-- Infrastructure Layers -->
                        <div class="pt-2">
                            <label for="sekolah-toggle" class="flex items-center justify-between p-3 bg-blue-50 rounded-md hover:bg-blue-100 cursor-pointer">
                                <div class="flex items-center">
                                    <i data-lucide="school" class="w-5 h-5 text-blue-600 mr-3"></i>
                                    <span class="font-medium text-blue-800">Lokasi Sekolah</span>
                                </div>
                                <input type="checkbox" id="sekolah-toggle" class="form-checkbox h-5 w-5 text-blue-600 rounded focus:ring-blue-500">
                            </label>
                        </div>
                         <div >
                            <label for="rs-toggle" class="flex items-center justify-between p-3 bg-green-50 rounded-md hover:bg-green-100 cursor-pointer">
                                <div class="flex items-center">
                                    <i data-lucide="hospital" class="w-5 h-5 text-green-600 mr-3"></i>
                                    <span class="font-medium text-green-800">Fasilitas Kesehatan</span>
                                </div>
                                <input type="checkbox" id="rs-toggle" class="form-checkbox h-5 w-5 text-green-600 rounded focus:ring-green-500">
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Risk Assessment Card (Initially hidden) -->
                <div id="risk-assessment" class="hidden">
                    <div class="flex justify-between items-center mb-3">
                        <h2 class="text-lg font-semibold text-gray-700">Laporan Risiko Lokasi</h2>
                        <button id="close-risk-assessment" class="p-1 text-gray-400 hover:text-gray-700">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </div>

                    <!-- Overall Risk -->
                    <div id="overall-risk-container" class="text-center p-4 rounded-lg mb-4">
                        <p class="text-sm font-medium uppercase tracking-wider" id="overall-risk-label">Tingkat Risiko</p>
                        <p class="text-3xl font-bold" id="overall-risk-level">SEDANG</p>
                    </div>

                    <!-- Risk Details -->
                    <div class="space-y-4">
                        <!-- Banjir Risk -->
                        <div>
                            <div class="flex justify-between items-end mb-1">
                                <span class="font-medium text-gray-700">Risiko Banjir</span>
                                <span class="text-sm font-semibold" id="banjir-risk-level">Sedang</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                <div id="banjir-risk-bar" class="bg-yellow-400 h-2.5 rounded-full" style="width: 50%"></div>
                            </div>
                            <p class="text-xs text-gray-500 mt-1" id="banjir-risk-info">Ditemukan 2 kejadian dalam radius 2km.</p>
                        </div>
                        <!-- Longsor Risk -->
                        <div>
                            <div class="flex justify-between items-end mb-1">
                                <span class="font-medium text-gray-700">Risiko Tanah Longsor</span>
                                <span class="text-sm font-semibold" id="longsor-risk-level">Rendah</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                <div id="longsor-risk-bar" class="bg-green-500 h-2.5 rounded-full" style="width: 20%"></div>
                            </div>
                            <p class="text-xs text-gray-500 mt-1" id="longsor-risk-info">Ditemukan 0 kejadian dalam radius 2km.</p>
                        </div>
                    </div>
                    
                    <!-- Nearest Neighbor Algorithm Results with Routing -->
                    <div class="mt-6 pt-4 border-t">
                        <h3 class="text-md font-semibold text-gray-700 mb-3">Fasilitas Aman Terdekat</h3>
                        <div class="space-y-3">
                            <div class="flex items-center">
                                <i data-lucide="school" class="w-8 h-8 text-blue-600 mr-4 flex-shrink-0"></i>
                                <div>
                                    <p class="font-semibold text-blue-800" id="nearest-school-name">Mencari...</p>
                                    <p class="text-sm text-gray-600" id="nearest-school-dist">Menghitung jarak jalan...</p>
                                </div>
                            </div>
                            <div class="flex items-center">
                                <i data-lucide="hospital" class="w-8 h-8 text-green-600 mr-4 flex-shrink-0"></i>
                                <div>
                                    <p class="font-semibold text-green-800" id="nearest-rs-name">Mencari...</p>
                                    <p class="text-sm text-gray-600" id="nearest-rs-dist">Menghitung jarak jalan...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <p class="text-xs text-gray-400 mt-4">*) Analisis berdasarkan data historis dalam radius 2km. Ini adalah estimasi dan bukan jaminan.</p>
                </div>

            </div>
            
            <div class="text-center mt-6 text-xs text-gray-400 border-t pt-4 flex-shrink-0">
                <p>Data pada peta ini adalah simulasi.</p>
            </div>
        </div>
    </div>

    <script>
        // --- DATA SIMULASI ---
        const banjirData = [
            { lat: -6.595, lng: 106.81, nama: 'Banjir Kampung Melayu', tipe: 'Banjir', tanggal: '12 Jan 2024', keterangan: 'Ketinggian air 1.5 meter akibat luapan sungai.' },
            { lat: -6.61, lng: 106.80, nama: 'Banjir Sempur', tipe: 'Banjir', tanggal: '22 Feb 2024', keterangan: 'Banjir bandang setelah hujan lebat selama 3 jam.' },
            { lat: -6.58, lng: 106.79, nama: 'Genangan Jalan Baru', tipe: 'Banjir', tanggal: '05 Mar 2025', keterangan: 'Drainase buruk menyebabkan genangan setinggi 50 cm.' }
        ];
        const longsorData = [
            { lat: -6.63, lng: 106.82, nama: 'Longsor Bukit Pelangi', tipe: 'Tanah Longsor', tanggal: '18 Agu 2024', keterangan: 'Tebing setinggi 10 meter longsor menutup akses jalan desa.' },
            { lat: -6.64, lng: 106.79, nama: 'Longsor Cijeruk', tipe: 'Tanah Longsor', tanggal: '29 Nov 2024', keterangan: 'Rumah warga di lereng bukit terdampak.' }
        ];
        const sekolahData = [
            { lat: -6.597, lng: 106.805, nama: 'SDN Bogor 1', tipe: 'Sekolah', keterangan: 'Sekolah Dasar Negeri di pusat kota.' },
            { lat: -6.62, lng: 106.81, nama: 'SMPN 3 Bogor', tipe: 'Sekolah', keterangan: 'Sekolah Menengah Pertama.' },
            { lat: -6.585, lng: 106.78, nama: 'SMA Harapan Bangsa', tipe: 'Sekolah', keterangan: 'Sekolah Menengah Atas Swasta.' }
        ];
        const rsData = [
            { lat: -6.60, lng: 106.79, nama: 'RSUD Kota Bogor', tipe: 'Rumah Sakit', keterangan: 'Rumah Sakit Umum Daerah Tipe A.' },
            { lat: -6.59, lng: 106.82, nama: 'Puskesmas Tegal Gundil', tipe: 'Puskesmas', keterangan: 'Pusat Kesehatan Masyarakat.' }
        ];

        // --- Inisialisasi Peta Leaflet ---
        const map = L.map('map').setView([-6.60, 106.80], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        // --- Ikon & Layer ---
        const createSvgIcon = (color) => {
            const svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="32" height="32" fill="${color}" stroke="white" stroke-width="1.5"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>`;
            return L.icon({
                iconUrl: `data:image/svg+xml;base64,${btoa(svg)}`,
                iconSize: [32, 32], iconAnchor: [16, 32], popupAnchor: [0, -32]
            });
        };
        const banjirIcon = createSvgIcon('#ef4444');
        const longsorIcon = createSvgIcon('#d97706');
        const sekolahIcon = createSvgIcon('#3b82f6');
        const rsIcon = createSvgIcon('#22c55e');

        const banjirLayer = L.layerGroup();
        const longsorLayer = L.layerGroup();
        const sekolahLayer = L.layerGroup();
        const rsLayer = L.layerGroup();
        
        function addMarkersToLayer(data, layer, icon) {
             data.forEach(item => {
                const marker = L.marker([item.lat, item.lng], { icon: icon });
                let popupContent = `<div class="text-base font-semibold text-gray-800">${item.nama}</div><div class="text-sm text-gray-600">${item.tipe}</div>`;
                if(item.tanggal) { popupContent += `<div class="text-xs text-gray-500 pt-1">Tanggal: ${item.tanggal}</div>`; }
                popupContent += `<hr class="my-2"><div class="text-sm text-gray-700">${item.keterangan}</div>`;
                marker.bindPopup(popupContent);
                marker.addTo(layer);
            });
        }
        addMarkersToLayer(banjirData, banjirLayer, banjirIcon);
        addMarkersToLayer(longsorData, longsorLayer, longsorIcon);
        addMarkersToLayer(sekolahData, sekolahLayer, sekolahIcon);
        addMarkersToLayer(rsData, rsLayer, rsIcon);

        banjirLayer.addTo(map); longsorLayer.addTo(map);

        document.getElementById('banjir-toggle').addEventListener('change', (e) => { e.target.checked ? map.addLayer(banjirLayer) : map.removeLayer(banjirLayer); });
        document.getElementById('longsor-toggle').addEventListener('change', (e) => { e.target.checked ? map.addLayer(longsorLayer) : map.removeLayer(longsorLayer); });
        document.getElementById('sekolah-toggle').addEventListener('change', (e) => { e.target.checked ? map.addLayer(sekolahLayer) : map.removeLayer(sekolahLayer); });
        document.getElementById('rs-toggle').addEventListener('change', (e) => { e.target.checked ? map.addLayer(rsLayer) : map.removeLayer(rsLayer); });
        
        // --- Risk Assessment, Nearest Neighbor & Routing Logic ---
        let locationMarker = null;
        let routingControl = null;
        const layerList = document.getElementById('layer-list');
        const riskAssessment = document.getElementById('risk-assessment');

        const pulsingIcon = L.divIcon({
            className: 'leaflet-div-icon',
            html: `<div class="w-6 h-6 bg-blue-500 rounded-full animate-pulse border-2 border-white shadow-lg"></div>`,
            iconSize: [24, 24],
            iconAnchor: [12, 12]
        });

        function calculateRisk(latlng) {
            const radius = 2000;
            let banjirCount = 0;
            let longsorCount = 0;

            banjirData.forEach(p => { if (map.distance(latlng, L.latLng(p.lat, p.lng)) < radius) banjirCount++; });
            longsorData.forEach(p => { if (map.distance(latlng, L.latLng(p.lat, p.lng)) < radius) longsorCount++; });
            
            const getRiskProfile = (count) => {
                if (count >= 2) return { level: 'Tinggi', color: 'red', textColor: 'text-red-600', bgColor: 'bg-red-600', width: '85%' };
                if (count === 1) return { level: 'Sedang', color: 'yellow', textColor: 'text-yellow-600', bgColor: 'bg-yellow-500', width: '50%' };
                return { level: 'Rendah', color: 'green', textColor: 'text-green-600', bgColor: 'bg-green-500', width: '15%' };
            };

            const banjirRisk = getRiskProfile(banjirCount);
            const longsorRisk = getRiskProfile(longsorCount);
            const totalCount = banjirCount + longsorCount;
            let overallRisk = (totalCount >= 3) ? getRiskProfile(2) : (totalCount >= 1) ? getRiskProfile(1) : getRiskProfile(0);

            return { banjir: { count: banjirCount, ...banjirRisk }, longsor: { count: longsorCount, ...longsorRisk }, overall: overallRisk };
        }
        
        function findNearestByStraightLine(latlng, facilityData) {
            let nearest = null;
            let minDistance = Infinity;

            facilityData.forEach(facility => {
                const distance = latlng.distanceTo(L.latLng(facility.lat, facility.lng));
                if (distance < minDistance) {
                    minDistance = distance;
                    nearest = facility;
                }
            });
            return { ...nearest, distance: minDistance };
        }

        function updateRiskCardUI(riskData) {
            // Overall
            document.getElementById('overall-risk-level').innerText = riskData.overall.level;
            const overallContainer = document.getElementById('overall-risk-container');
            overallContainer.className = `text-center p-4 rounded-lg mb-4 bg-${riskData.overall.color}-100`;
            document.getElementById('overall-risk-label').className = `text-sm font-medium uppercase tracking-wider text-${riskData.overall.color}-800`;
            document.getElementById('overall-risk-level').className = `text-3xl font-bold text-${riskData.overall.color}-800`;
            
            // Banjir & Longsor
            document.getElementById('banjir-risk-level').innerText = riskData.banjir.level;
            document.getElementById('banjir-risk-level').className = `text-sm font-semibold ${riskData.banjir.textColor}`;
            document.getElementById('banjir-risk-bar').style.width = riskData.banjir.width;
            document.getElementById('banjir-risk-bar').className = `h-2.5 rounded-full ${riskData.banjir.bgColor}`;
            document.getElementById('banjir-risk-info').innerText = `Ditemukan ${riskData.banjir.count} kejadian dalam radius 2km.`;
            document.getElementById('longsor-risk-level').innerText = riskData.longsor.level;
            document.getElementById('longsor-risk-level').className = `text-sm font-semibold ${riskData.longsor.textColor}`;
            document.getElementById('longsor-risk-bar').style.width = riskData.longsor.width;
            document.getElementById('longsor-risk-bar').className = `h-2.5 rounded-full ${riskData.longsor.bgColor}`;
            document.getElementById('longsor-risk-info').innerText = `Ditemukan ${riskData.longsor.count} kejadian dalam radius 2km.`;
        }

        map.on('click', function(e) {
            const clickedLatLng = e.latlng;
            
            if (!locationMarker) {
                locationMarker = L.marker(clickedLatLng, { icon: pulsingIcon }).addTo(map);
            } else {
                locationMarker.setLatLng(clickedLatLng);
            }

            if (routingControl) {
                map.removeControl(routingControl);
                routingControl = null;
            }

            // 1. Update risk analysis UI
            const riskData = calculateRisk(clickedLatLng);
            updateRiskCardUI(riskData);
            
            // 2. Find nearest facilities by straight line
            const nearestSchool = findNearestByStraightLine(clickedLatLng, sekolahData);
            const nearestRs = findNearestByStraightLine(clickedLatLng, rsData);

            // 3. Update UI with names and "calculating..." message
            document.getElementById('nearest-school-name').textContent = nearestSchool.nama;
            document.getElementById('nearest-rs-name').textContent = nearestRs.nama;
            document.getElementById('nearest-school-dist').textContent = 'Menghitung jarak jalan...';
            document.getElementById('nearest-rs-dist').textContent = 'Menghitung jarak jalan...';
            
            // 4. Create routing control to calculate and display route to nearest SCHOOL
            const schoolRouter = L.Routing.control({
                waypoints: [ clickedLatLng, L.latLng(nearestSchool.lat, nearestSchool.lng) ],
                routeWhileDragging: false,
                createMarker: () => null,
                lineOptions: { styles: [{color: '#2563eb', opacity: 0.8, weight: 6}] }
            }).on('routesfound', function(e) {
                const distance = (e.routes[0].summary.totalDistance / 1000).toFixed(2);
                document.getElementById('nearest-school-dist').textContent = `Jarak Jalan Raya: ${distance} km`;
            }).addTo(map);

            // 5. Create another routing control for the nearest HOSPITAL
            const rsRouter = L.Routing.control({
                waypoints: [ clickedLatLng, L.latLng(nearestRs.lat, nearestRs.lng) ],
                createMarker: () => null,
                lineOptions: { styles: [{color: '#16a34a', opacity: 0.0, weight: 0}] } // This route is not drawn
            }).on('routesfound', function(e) {
                 const distance = (e.routes[0].summary.totalDistance / 1000).toFixed(2);
                document.getElementById('nearest-rs-dist').textContent = `Jarak Jalan Raya: ${distance} km`;
            });
            // Note: We don't add the hospital route to the map to avoid clutter. We just use it for calculation.

            routingControl = schoolRouter; // Store reference to remove it later

            layerList.classList.add('hidden');
            riskAssessment.classList.remove('hidden');
        });
        
        document.getElementById('close-risk-assessment').addEventListener('click', () => {
             riskAssessment.classList.add('hidden');
             layerList.classList.remove('hidden');
             if (locationMarker) {
                 map.removeLayer(locationMarker);
                 locationMarker = null;
             }
             if (routingControl) {
                map.removeControl(routingControl);
                routingControl = null;
            }
        });

        // --- Inisialisasi Lucide Icons & Waktu ---
        lucide.createIcons();
        
        const timeElement = document.getElementById('current-time');
        const now = new Date();
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', timeZone: 'Asia/Makassar', timeZoneName: 'short' };
        timeElement.textContent = `${now.toLocaleDateString('id-ID', options)}`;

    </script>
</body>
</html>

